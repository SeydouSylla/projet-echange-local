<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laisser un avis - Échange Local</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link th:href="@{/css/avis.css}" rel="stylesheet">
</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
        <a class="navbar-brand" href="/accueil">
            <i class="fas fa-exchange-alt me-2"></i>Échange Local
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="mainNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item"><a class="nav-link" href="/accueil"><i class="fas fa-home me-1"></i>Accueil</a></li>
                <li class="nav-item"><a class="nav-link" href="/annonces/liste"><i class="fas fa-box me-1"></i>Objets</a></li>
                <li class="nav-item"><a class="nav-link" href="/competences/liste"><i class="fas fa-hands-helping me-1"></i>Compétences</a></li>
                <li class="nav-item"><a class="nav-link" href="/echanges/mes-demandes"><i class="fas fa-exchange-alt me-1"></i>Mes échanges</a></li>
            </ul>
            <ul class="navbar-nav ms-auto">
                <th:block th:if="${session.utilisateur != null}">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" data-bs-toggle="dropdown" role="button">
                            <th:block th:if="${session.utilisateur.photoProfil}">
                                <img th:src="@{'/uploads/profils/' + ${session.utilisateur.photoProfil}}" class="rounded-circle me-2" width="32" height="32" alt="Photo">
                            </th:block>
                            <th:block th:unless="${session.utilisateur.photoProfil}">
                                <div class="rounded-circle bg-light d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                                    <i class="fas fa-user text-muted"></i>
                                </div>
                            </th:block>
                            <span th:text="${session.utilisateur.prenom}"></span>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end">
                            <a class="dropdown-item" href="/profil"><i class="fas fa-user me-2"></i>Mon profil</a>
                            <a class="dropdown-item" href="/avis/mes-avis"><i class="fas fa-star me-2"></i>Mes avis</a>
                            <a class="dropdown-item" href="/echanges/mes-demandes"><i class="fas fa-exchange-alt me-2"></i>Mes échanges</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item text-danger" href="/deconnexion"><i class="fas fa-sign-out-alt me-2"></i>Déconnexion</a>
                        </div>
                    </li>
                </th:block>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <!-- Fil d'Ariane -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/accueil">Accueil</a></li>
            <li class="breadcrumb-item"><a href="/echanges/mes-demandes">Mes échanges</a></li>
            <li class="breadcrumb-item active" aria-current="page">Laisser un avis</li>
        </ol>
    </nav>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- En-tête -->
            <div class="text-center mb-4">
                <h1 class="h3">
                    <i class="fas fa-star text-warning me-2"></i>
                    <span th:text="${modification != null ? 'Modifier votre avis' : 'Laisser un avis'}">Laisser un avis</span>
                </h1>
                <p class="text-muted">Partagez votre expérience avec la communauté</p>
            </div>

            <!-- Informations sur l'échange -->
            <div class="card mb-4 border-primary">
                <div class="card-body">
                    <h6 class="card-subtitle mb-3 text-primary">
                        <i class="fas fa-info-circle me-2"></i>Informations sur l'échange
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-2">
                                <strong>Objet/Compétence :</strong>
                                <th:block th:if="${demande.annonce != null}">
                                    <span th:text="${demande.annonce.titre}"></span>
                                </th:block>
                                <th:block th:if="${demande.competence != null}">
                                    <span th:text="${demande.competence.titre}"></span>
                                </th:block>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-2">
                                <strong>Avec :</strong>
                                <th:block th:if="${utilisateur.id == demande.demandeur.id}">
                                    <span th:text="${demande.destinataire.prenom + ' ' + demande.destinataire.nom}"></span>
                                </th:block>
                                <th:block th:if="${utilisateur.id == demande.destinataire.id}">
                                    <span th:text="${demande.demandeur.prenom + ' ' + demande.demandeur.nom}"></span>
                                </th:block>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formulaire d'avis -->
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="fas fa-comment-dots me-2"></i>Votre évaluation</h5>
                </div>
                <div class="card-body">
                    <form th:action="@{${modification != null ? '/avis/modifier/' + avisDto.id : '/avis/laisser'}}"
                          method="post"
                          th:object="${avisDto}">

                        <input type="hidden" th:field="*{demandeEchangeId}">

                        <!-- Note (Étoiles) -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                Note <span class="text-danger">*</span>
                            </label>
                            <div class="rating-container">
                                <div class="star-rating">
                                    <input type="radio" th:field="*{note}" value="5" id="star5" required>
                                    <label for="star5" title="5 étoiles">
                                        <i class="fas fa-star"></i>
                                    </label>

                                    <input type="radio" th:field="*{note}" value="4" id="star4">
                                    <label for="star4" title="4 étoiles">
                                        <i class="fas fa-star"></i>
                                    </label>

                                    <input type="radio" th:field="*{note}" value="3" id="star3">
                                    <label for="star3" title="3 étoiles">
                                        <i class="fas fa-star"></i>
                                    </label>

                                    <input type="radio" th:field="*{note}" value="2" id="star2">
                                    <label for="star2" title="2 étoiles">
                                        <i class="fas fa-star"></i>
                                    </label>

                                    <input type="radio" th:field="*{note}" value="1" id="star1">
                                    <label for="star1" title="1 étoile">
                                        <i class="fas fa-star"></i>
                                    </label>
                                </div>
                                <div class="rating-description mt-2 text-muted small"></div>
                            </div>
                            <div class="text-danger mt-1" th:if="${#fields.hasErrors('note')}">
                                <small th:errors="*{note}"></small>
                            </div>
                        </div>

                        <!-- Commentaire -->
                        <div class="mb-4">
                            <label for="commentaire" class="form-label fw-bold">
                                Votre commentaire <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control"
                                      id="commentaire"
                                      th:field="*{commentaire}"
                                      rows="6"
                                      required
                                      placeholder="Décrivez votre expérience : ponctualité, état de l'objet/qualité du service, communication...">
                            </textarea>
                            <div class="form-text">
                                Minimum 10 caractères. Soyez constructif et respectueux.
                            </div>
                            <div class="text-danger mt-1" th:if="${#fields.hasErrors('commentaire')}">
                                <small th:errors="*{commentaire}"></small>
                            </div>
                        </div>

                        <!-- Boutons -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a class="btn btn-secondary" th:href="@{/echanges/mes-demandes}">
                                <i class="fas fa-times me-1"></i>Annuler
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane me-1"></i>
                                <span th:text="${modification != null ? 'Modifier l\'avis' : 'Publier l\'avis'}">Publier l'avis</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Conseils -->
            <div class="card mt-4 bg-light">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="fas fa-lightbulb text-warning me-2"></i>
                        Conseils pour un avis utile
                    </h6>
                    <ul class="mb-0 small">
                        <li>Soyez honnête et constructif</li>
                        <li>Mentionnez ce qui s'est bien passé et ce qui pourrait être amélioré</li>
                        <li>Restez courtois et respectueux</li>
                        <li>Évitez les informations personnelles sensibles</li>
                        <li>Vous pouvez modifier votre avis dans les 24h après publication</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer class="bg-dark text-white mt-5 py-4">
    <div class="container text-center">
        <p class="mb-0">
            <i class="fas fa-exchange-alt me-2"></i>Échange Local - Développé avec Spring Boot & Bootstrap
        </p>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Gestion des étoiles interactives
        const stars = document.querySelectorAll('.star-rating input');
        const ratingDescription = document.querySelector('.rating-description');

        const descriptions = {
            '1': '⭐ Très décevant',
            '2': '⭐⭐ Décevant',
            '3': '⭐⭐⭐ Satisfaisant',
            '4': '⭐⭐⭐⭐ Très bien',
            '5': '⭐⭐⭐⭐⭐ Excellent !'
        };

        stars.forEach(star => {
            star.addEventListener('change', function() {
                ratingDescription.textContent = descriptions[this.value];
                ratingDescription.classList.add('text-primary', 'fw-bold');
            });
        });

        // Afficher la description pour la note déjà sélectionnée
        const selectedStar = document.querySelector('.star-rating input:checked');
        if (selectedStar) {
            ratingDescription.textContent = descriptions[selectedStar.value];
            ratingDescription.classList.add('text-primary', 'fw-bold');
        }
    });
</script>
</body>
</html>